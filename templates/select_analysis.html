<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analiz Seçimi - Excel Veri Analiz Aracı</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-10 offset-md-1">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h2>Analiz Seçimi</h2>
                        <p class="mb-0">Verilerinizle hangi analizleri yapmak istediğinizi seçin</p>
                    </div>
                    <div class="card-body">
                        <!-- Flash mesajları -->
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                        
                        <div class="progress mb-4">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">3/4 Adım</div>
                        </div>

                        <div class="row">
                            <!-- Sol taraf: Analiz seçimi -->
                            <div class="col-md-5">
                                <div class="card border-primary mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h4 class="mb-0">Analiz Seçenekleri</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-4">
                                            <h5><i class="fas fa-calculator me-2"></i>Özet İstatistikler</h5>
                                            <p>Seçilen sayısal sütunlar için temel istatistikler (ortalama, medyan, standart sapma, vb.)</p>
                                            <div class="form-group">
                                                <label for="summaryStatsColumns" class="form-label">Sütun Seçin:</label>
                                                <select class="form-select select2" id="summaryStatsColumns" multiple="multiple" data-placeholder="Sütunlar seçin...">
                                                    {% for column in stats.numerical_columns %}
                                                        <option value="{{ column }}">{{ column }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <button type="button" class="btn btn-outline-primary mt-2 w-100" onclick="performAnalysis('summary_stats', 'summaryStatsColumns')">
                                                <i class="fas fa-chart-line me-2"></i>Özet İstatistikleri Göster
                                            </button>
                                        </div>

                                        <div class="mb-4">
                                            <h5><i class="fas fa-project-diagram me-2"></i>Korelasyon Analizi</h5>
                                            <p>Sayısal sütunlar arasındaki ilişkiyi ölçen korelasyon analizi</p>
                                            <div class="form-group">
                                                <label for="correlationColumns" class="form-label">Sütun Seçin (en az 2):</label>
                                                <select class="form-select select2" id="correlationColumns" multiple="multiple" data-placeholder="Sütunlar seçin...">
                                                    {% for column in stats.numerical_columns %}
                                                        <option value="{{ column }}">{{ column }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <button type="button" class="btn btn-outline-primary mt-2 w-100" onclick="performAnalysis('correlation', 'correlationColumns')">
                                                <i class="fas fa-table me-2"></i>Korelasyon Analizi Yap
                                            </button>
                                        </div>

                                        {% if stats.date_columns %}
                                        <div class="mb-4">
                                            <h5><i class="fas fa-calendar-alt me-2"></i>Zaman Serisi Analizi</h5>
                                            <p>Tarih sütunu üzerinde zaman içindeki değişimi gösteren analiz</p>
                                            <div class="form-group">
                                                <label for="timeSeriesDateColumn" class="form-label">Tarih Sütunu:</label>
                                                <select class="form-select" id="timeSeriesDateColumn">
                                                    {% for column in stats.date_columns %}
                                                        <option value="{{ column }}">{{ column }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group mt-2">
                                                <label for="timeSeriesValueColumns" class="form-label">Değer Sütunları:</label>
                                                <select class="form-select select2" id="timeSeriesValueColumns" multiple="multiple" data-placeholder="Değer sütunları seçin...">
                                                    {% for column in stats.numerical_columns %}
                                                        <option value="{{ column }}">{{ column }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <button type="button" class="btn btn-outline-primary mt-2 w-100" onclick="performTimeSeriesAnalysis()">
                                                <i class="fas fa-chart-line me-2"></i>Zaman Serisi Analizi Yap
                                            </button>
                                        </div>
                                        {% endif %}

                                        <div class="mb-4">
                                            <h5><i class="fas fa-chart-pie me-2"></i>Kategorik Analiz</h5>
                                            <p>Kategorik verilerin dağılımını ve ilişkilerini gösteren analiz</p>
                                            <div class="form-group">
                                                <label for="categoricalColumns" class="form-label">Sütun Seçin (1 veya 2):</label>
                                                <select class="form-select select2" id="categoricalColumns" multiple="multiple" data-placeholder="Sütunlar seçin...">
                                                    {% for column in stats.categorical_columns %}
                                                        <option value="{{ column }}">{{ column }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <button type="button" class="btn btn-outline-primary mt-2 w-100" onclick="performAnalysis('categorical', 'categoricalColumns')">
                                                <i class="fas fa-chart-pie me-2"></i>Kategorik Analiz Yap
                                            </button>
                                        </div>

                                        <div class="mb-4">
                                            <h5><i class="fas fa-chart-bar me-2"></i>Dağılım Analizi</h5>
                                            <p>Sayısal veriler için dağılım histogramları ve kutu grafikleri</p>
                                            <div class="form-group">
                                                <label for="distributionColumns" class="form-label">Sütun Seçin:</label>
                                                <select class="form-select select2" id="distributionColumns" multiple="multiple" data-placeholder="Sütunlar seçin...">
                                                    {% for column in stats.numerical_columns %}
                                                        <option value="{{ column }}">{{ column }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <button type="button" class="btn btn-outline-primary mt-2 w-100" onclick="performAnalysis('distribution', 'distributionColumns')">
                                                <i class="fas fa-chart-bar me-2"></i>Dağılım Analizi Yap
                                            </button>
                                        </div>

                                        <div class="mb-4">
                                            <h5><i class="fas fa-braille me-2"></i>Dağılım Grafiği</h5>
                                            <p>İki sayısal sütun arasındaki ilişkiyi gösteren dağılım grafiği</p>
                                            <div class="form-group">
                                                <label for="scatterXColumn" class="form-label">X Ekseni:</label>
                                                <select class="form-select" id="scatterXColumn">
                                                    <option value="">Sütun seçin...</option>
                                                    {% for column in stats.numerical_columns %}
                                                        <option value="{{ column }}">{{ column }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group mt-2">
                                                <label for="scatterYColumn" class="form-label">Y Ekseni:</label>
                                                <select class="form-select" id="scatterYColumn">
                                                    <option value="">Sütun seçin...</option>
                                                    {% for column in stats.numerical_columns %}
                                                        <option value="{{ column }}">{{ column }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <button type="button" class="btn btn-outline-primary mt-2 w-100" onclick="performScatterAnalysis()">
                                                <i class="fas fa-braille me-2"></i>Dağılım Grafiği Oluştur
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <a href="{{ url_for('understand_data') }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Geri
                                    </a>
                                    <form action="{{ url_for('analysis_results') }}" method="get">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-primary">
                                            Analizleri Tamamla<i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- Sağ taraf: Sonuçlar -->
                            <div class="col-md-7">
                                <div class="card border-success" id="resultsCard">
                                    <div class="card-header bg-success text-white">
                                        <h4 class="mb-0">Analiz Sonuçları</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="text-center py-5" id="initialMessage">
                                            <i class="fas fa-chart-bar fa-4x mb-3 text-muted"></i>
                                            <h5>Sonuçları görmek için soldaki analizlerden birini seçin</h5>
                                            <p class="text-muted">Her analiz burada görüntülenecek ve sonuçlar sayfasına eklenecektir.</p>
                                        </div>
                                        <div id="analysisResults" class="d-none">
                                            <!-- Analiz sonuçları buraya eklenecek -->
                                        </div>
                                        <div id="loadingIndicator" class="text-center py-5 d-none">
                                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                                <span class="visually-hidden">Yükleniyor...</span>
                                            </div>
                                            <h5 class="mt-3">Analiz yapılıyor...</h5>
                                            <p class="text-muted">Lütfen bekleyin, bu işlem dosya boyutuna bağlı olarak birkaç saniye sürebilir.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Select2 başlat
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%'
            });
        });
        
        // Analiz yapma fonksiyonu
        function performAnalysis(analysisType, selectId) {
            const columns = $('#' + selectId).val();
            
            if (analysisType === 'summary_stats' && columns.length === 0) {
                alert('Lütfen en az bir sayısal sütun seçin.');
                return;
            }
            
            if (analysisType === 'correlation' && columns.length < 2) {
                alert('Korelasyon analizi için en az 2 sütun seçmelisiniz.');
                return;
            }
            
            if (analysisType === 'categorical' && (columns.length === 0 || columns.length > 2)) {
                alert('Kategorik analiz için 1 veya 2 sütun seçmelisiniz.');
                return;
            }
            
            if (analysisType === 'distribution' && columns.length === 0) {
                alert('Lütfen en az bir sayısal sütun seçin.');
                return;
            }
            
            showLoading();
            
            // AJAX isteği
            fetch('{{ url_for("perform_analysis") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    analysis_type: analysisType,
                    columns: columns
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Analiz sırasında bir hata oluştu.');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                displayResults(analysisType, data);
            })
            .catch(error => {
                hideLoading();
                alert('Hata: ' + error.message);
                console.error('Analiz hatası:', error);
            });
        }
        
        // Zaman serisi analizi
        function performTimeSeriesAnalysis() {
            const dateColumn = $('#timeSeriesDateColumn').val();
            const valueColumns = $('#timeSeriesValueColumns').val();
            
            if (!dateColumn) {
                alert('Lütfen bir tarih sütunu seçin.');
                return;
            }
            
            if (valueColumns.length === 0) {
                alert('Lütfen en az bir değer sütunu seçin.');
                return;
            }
            
            const columns = [dateColumn, ...valueColumns];
            
            showLoading();
            
            // AJAX isteği
            fetch('{{ url_for("perform_analysis") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    analysis_type: 'time_series',
                    columns: columns
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Analiz sırasında bir hata oluştu.');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                displayResults('time_series', data);
            })
            .catch(error => {
                hideLoading();
                alert('Hata: ' + error.message);
                console.error('Analiz hatası:', error);
            });
        }
        
        // Dağılım grafiği analizi
        function performScatterAnalysis() {
            const xColumn = $('#scatterXColumn').val();
            const yColumn = $('#scatterYColumn').val();
            
            if (!xColumn || !yColumn) {
                alert('Lütfen X ve Y eksenleri için sütun seçin.');
                return;
            }
            
            showLoading();
            
            // AJAX isteği
            fetch('{{ url_for("perform_analysis") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    analysis_type: 'scatter',
                    columns: [xColumn, yColumn]
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Analiz sırasında bir hata oluştu.');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                displayResults('scatter', data);
            })
            .catch(error => {
                hideLoading();
                alert('Hata: ' + error.message);
                console.error('Analiz hatası:', error);
            });
        }
        
        // Yükleme göstergesi
        function showLoading() {
            $('#initialMessage').addClass('d-none');
            $('#analysisResults').addClass('d-none');
            $('#loadingIndicator').removeClass('d-none');
        }
        
        function hideLoading() {
            $('#loadingIndicator').addClass('d-none');
            $('#analysisResults').removeClass('d-none');
        }
        
        // Sonuçları gösterme
        function displayResults(analysisType, response) {
            const resultDiv = document.getElementById('analysisResults');
            let resultHtml = '';
            
            // Analiz tipine göre sonuçları göster
            if (analysisType === 'summary_stats') {
                resultHtml = '<h4>Özet İstatistikler</h4>';
                
                if (response.error) {
                    resultHtml += `<div class="alert alert-danger">${response.error}</div>`;
                } else {
                    resultHtml += '<div class="table-responsive"><table class="table table-striped table-bordered">';
                    resultHtml += '<thead class="table-primary"><tr><th>İstatistik</th>';
                    
                    // Sütun başlıkları
                    for (const column in response) {
                        if (column !== 'error') {
                            resultHtml += `<th>${column}</th>`;
                        }
                    }
                    resultHtml += '</tr></thead><tbody>';
                    
                    // İstatistiklerin hangi sırada gösterileceği
                    const stats = ['count', 'mean', 'std', 'min', '25%', '50%', '75%', 'max'];
                    const statNames = {
                        'count': 'Sayı',
                        'mean': 'Ortalama',
                        'std': 'Standart Sapma',
                        'min': 'Minimum',
                        '25%': 'Birinci Çeyrek (25%)',
                        '50%': 'Medyan (50%)',
                        '75%': 'Üçüncü Çeyrek (75%)',
                        'max': 'Maksimum'
                    };
                    
                    for (const stat of stats) {
                        resultHtml += `<tr><td><strong>${statNames[stat] || stat}</strong></td>`;
                        for (const column in response) {
                            if (column !== 'error') {
                                let value = response[column][stat];
                                if (typeof value === 'number') {
                                    value = value.toFixed(2);
                                }
                                resultHtml += `<td>${value}</td>`;
                            }
                        }
                        resultHtml += '</tr>';
                    }
                    
                    resultHtml += '</tbody></table></div>';
                }
            }
            
            resultDiv.innerHTML = resultHtml;
        }
    </script>
</body>
</html>
